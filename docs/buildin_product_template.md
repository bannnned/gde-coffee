# Gde Coffee - Product Operating Doc (BuildIn Template)

> Формат: Markdown для вставки в BuildIn.  
> Назначение: единый источник правды по продукту, MVP, рейтингу, геймификации и roadmap.

## Как использовать этот шаблон

1. Дублируй эту страницу на каждый релиз (`MVP`, `v1.1`, `v2`).
2. Не дублируй факты между разделами: в каждом разделе только свой уровень решений.
3. Любая задача оформляется как `гипотеза -> действие -> метрика -> дедлайн`.
4. Обновляй блок `0. Метаданные` в начале недели.

## 0. Метаданные документа

| Поле | Значение |
|---|---|
| Продукт | Gde Coffee |
| Версия документа | v1 |
| Статус | Draft |
| Владелец (Product) | _указать_ |
| Владелец (Tech) | _указать_ |
| Дата обновления | _YYYY-MM-DD_ |
| Города в фокусе | _указать_ |
| Ссылка на дизайн | _указать_ |
| Ссылка на дашборд метрик | _указать_ |

---

## 1. Product One-Pager

### 1.1 Суть продукта

**Приложение для поиска ближайшего лучшего кофе.**  
**Найди свою спешалти-кофейню за секунды.**

### 1.2 Ценность для пользователя

- Глубокая информация по кофейням (не только рейтинг, но и контекст).
- Экспертное вовлеченное сообщество.
- Личные подборки и персонализация.
- Быстрое действие: открыть, выбрать, построить маршрут.

### 1.3 Ценность для кофейни (B2B-угол)

- Пользователи приходят за новым опытом и атмосферой.
- Прозрачная карточка кофейни повышает доверие и офлайн-трафик.
- Обратная связь от аудитории помогает улучшать сервис.

### 1.4 Бренд-система (базовая)

| Токен | Цвет | Hex |
|---|---|---|
| `bg.coffee` | Кофейный | `#EADCC8` |
| `brand.emerald` | Изумруд | `#457E73` |
| `text.primary` | Черный | `#1A1A1A` |
| `text.inverse` | Белый (теплый) | `#FFFFF0` |

### 1.5 North Star и ключевые метрики

**North Star (черновик):** количество полезных подтвержденных отзывов, которые читают перед визитом.

| Тип | Метрика | Целевое значение |
|---|---|---|
| NSM | Полезные подтвержденные отзывы / неделя | _указать_ |
| Product | Карточка -> Маршрут конверсия | _указать_ |
| Product | Доля пользователей с `first value <= 10s` | _указать_ |
| Trust | Доля отзывов с verified visit | _указать_ |
| Quality | Доля модераторских отклонений | _указать_ |

### 1.6 Гипотезы монетизации (черновик)

- `H1`: Подтвержденный профиль кофейни (B2B подписка).
- `H2`: Sponsored placement с прозрачной маркировкой.
- `H3`: Партнерские офферы/лиды (оборудование, зерно, курсы).

---

## 2. MVP Spec

### 2.1 MVP-цель релиза (Definition of MVP)

Пользователь открывает PWA -> за <= 10 секунд получает **1 "Лучшее место рядом"** (под выбранный напиток) + 2-3 альтернативы -> применяет быстрые фильтры -> видит на карте -> в 1 тап строит маршрут -> сохраняет в избранное.

### 2.2 Термины интерфейса

- `Map + Bottom Sheet`: карта на фоне + перетаскиваемая нижняя панель.
- `Detents`:
1. `Expanded`: карта ~1/5, sheet ~4/5 (дефолт, рекомендации).
2. `Medium`: карта ~2/3, sheet ~1/3 (смотреть на карте).
3. `Collapsed/Pill`: карта 100%, sheet в виде пилюли.

### 2.3 Scope по приоритетам

| Priority | Что входит | Статус |
|---|---|---|
| P0 | Best place + 2-3 альтернативы рядом | [ ] |
| P0 | Быстрые фильтры + синхронное обновление списка/пинов/best place | [ ] |
| P0 | Map + Bottom Sheet c 3 detents | [ ] |
| P0 | Маршрут в 1 тап | [ ] |
| P0 | Избранное | [x] |
| P0 | Fallback без гео: показывать популярные места | [ ] |
| P1 | Показывать оценку и число отзывов на карточке главного экрана | [ ] |
| P1 | Простые комментарии к кофейням + авто-модерация | [ ] |
| P1 | Рекомендации "попробуйте" в карточке | [ ] |
| P2 | База геймификации | [ ] |

### 2.4 Критерии приемки ключевого сценария

- [ ] При открытии в зоне с GPS: появляется `Best place` + кнопка `Маршрут`.
- [ ] Тап по карте переводит UI в `карта 2/3` без смены экрана.
- [ ] Свайп вниз скрывает sheet и оставляет `пилюлю` с Best place.
- [ ] Фильтр `Открыто` обновляет список, пины и лучший вариант.
- [ ] Переключение напитка меняет выдачу и объяснение `почему`.
- [ ] `Маршрут` открывается в 1 действие и ведет к выбранной кофейне.

### 2.5 Наблюдаемость MVP (обязательно добавить)

- [ ] События аналитики на каждом шаге сценария.
- [ ] Метрики API latency и 5xx.
- [ ] Метрики idempotency replay rate.
- [ ] Метрики ложных срабатываний антиспама.

---

## 3. Game + Rating Design

### 3.1 Что вознаграждаем (valuable actions)

- Проверенный визит.
- Качественный отзыв.
- Фото "как есть" (меню/цены/чашка/интерьер).
- Обновление данных, прошедшее модерацию.
- Добавление новой кофейни.
- Ответы бариста/кофейни.
- Кураторство (подборки/маршруты).

### 3.2 Двухконтурная модель

**A. Рейтинг кофейни (публичный):**
- звезды 1-5,
- сила уверенности,
- декомпозиция по аспектам.

**B. Репутация пользователя (вес вклада):**
- растет за качественный вклад,
- падает за подтвержденные нарушения,
- влияет на вес сигналов, но с ограничением сверху.

### 3.3 Формулы v1

#### review_quality_v1 (0-100)

```text
drink = 1, если drink_id заполнен, иначе 0
tags = min(tag_count, 5) / 5

text =
  0.0, если length < 60
  0.4, если 60..99
  0.7, если 100..179
  1.0, если >= 180

photo = min(photo_count, 3) / 3

visit =
  0.0 (none)
  0.4 (low)
  0.7 (medium)
  1.0 (high)

base = 100 * (
  0.20*drink +
  0.20*tags +
  0.25*text +
  0.20*photo +
  0.15*visit
)

penalty = 20*confirmed_report_count + 40*is_removed_by_moderation

review_quality_v1 = clamp(round(base - penalty), 0, 100)
```

#### reputation_v1_1 (0-1000)

```text
rep_raw = Σ(applied_points(event_k) * decay(age_k))

decay(age_k):
  1.0, если событие <= 90 дней
  0.7, если событие 91..180 дней
  0.4, если событие 181..365 дней
  0.2, если событие > 365 дней

События:
+2 * voter_weight      за каждый полученный "полезно"
+3 / +6 / +8          за verified visit (low / medium / high)
+4                    за одобренное обновление данных кофейни
+8                    за одобренное добавление кофейни
-25                   за подтвержденную жалобу
-15                   за удаление отзыва за нарушение

Ограничения:
daily_cap(helpful_received) = +20
daily_cap(visit_verified)   = +24

reputation_v1_1 = clamp(rep_raw, 0, 1000)

Уровни (Level + progress):
L1: 0, L2: 40, L3: 120, L4: 180, L5: 320, L6: 500, L7: 750
```

#### rating_v1 кофейни (1.0-5.0)

```text
Для каждого отзыва i:

time_i = exp(-ln(2) * age_days_i / 180)
quality_i = 0.8 + 0.4*(review_quality_i/100)
author_i = 0.85 + 0.3*(author_rep_i/1000)
visit_i = 1 + 0.15*visit_score_i

w_i = time_i * quality_i * author_i * visit_i

mu = Σ(w_i * rating_i) / Σ(w_i)
N_eff = Σ(w_i)

base = (N_eff/(N_eff + 20))*mu + (20/(N_eff + 20))*GLOBAL_MEAN

final_rating_v1 = clamp(base - 0.6*fraud_risk, 1.0, 5.0)
```

### 3.4 Игровой слой (после стабилизации trust)

- Ранги: Новичок -> Искатель -> Дегустатор -> Куратор -> Локальный эксперт -> Легенда района.
- Недельные задания: исследование, вклад, социальные.
- Ачивки: explorer, quality, community, seasonal, secret.
- Принцип: награда за качество, не за количество.

### 3.5 Anti-fraud и trust guardrails

- [ ] Проверенный визит: гео + таймер + лимиты.
- [ ] Ограничения на действия для новых аккаунтов.
- [ ] Снижение веса подозрительных сигналов до модерации.
- [ ] Полные логи действий модераторов.

### 3.6 Versioning и безопасный rollout

- [x] Явное версионирование (`rating_v2`, `quality_v1`).
- [x] Feature flags на формулы и API-контракты.
- [ ] Политика миграции v1 -> v2 без ретроспективных поломок.

---

## 4. Execution Roadmap

### 4.1 Что уже сделано (фундамент)

- [x] S3 интеграция и показ фото.
- [x] Роли и разделение прав.
- [x] Добавление фото (админ и пользователь с модерацией).
- [x] Добавление кофейни с модерацией.
- [x] Авторизация.
- [x] Карточка кофейни + избранное + редактирование описания.
- [x] Профиль: репутация, отзывы.
- [x] Админка модерации: кофейни, отзывы, фото, описания.
- [x] Декомпозиция больших UI-компонентов.
- [x] Версионирование формул/контрактов и feature flags.
- [x] Усиление событийной надежности (outbox/inbox + DLQ).
- [x] Оптимизация фронта (bundle split/lazy для тяжелых частей).

### 4.2 Бэклог CTO (приоритет)

| Priority | Задача | Статус | Метрика успеха | Дедлайн |
|---|---|---|---|---|
| P0 | Наблюдаемость: очереди, latency, 5xx, replay rate, false-positive антиспама | [ ] | Дашборд + алерты в проде | _указать_ |
| P0 | E2E критических сценариев: отзыв/helpful/check-in/модерация/snapshot | [ ] | Зеленый nightly e2e | _указать_ |
| P0 | Ротация секретов и контроль утечек | [ ] | 0 секретов в git + ротация выполнена | _указать_ |
| P1 | Explainability рейтинга в UI | [ ] | +CTR в карточке, меньше жалоб на рейтинг | _указать_ |
| P1 | Оптимизация image pipeline + cache policy | [ ] | Улучшение LCP/INP | _указать_ |

### 4.3 Бэклог CPO (приоритет)

| Priority | Задача | Статус | Метрика успеха | Дедлайн |
|---|---|---|---|---|
| P0 | Зафиксировать North Star и quality-guardrails | [ ] | Утверждена метрика и цели | _указать_ |
| P0 | Построить воронку: карточка -> отзыв -> маршрут -> check-in -> отзыв | [x] | Сквозная аналитика доступна | _указать_ |
| P1 | Cold-start стратегия по городам | [ ] | N trust contributors / город | _указать_ |
| P1 | Авто-модерация low-risk кейсов | [ ] | Снижение ручной нагрузки | _указать_ |
| P2 | Мягкий запуск B2B профиля кофейни | [ ] | Первые платящие кофейни | _указать_ |

### 4.4 Что сократить/удалить

- [ ] Избыточные UI-эффекты, мешающие читаемости на улице.
- [ ] Игровые механики, стимулирующие накрутку до зрелости антифрода.
- [ ] Vanity metrics без связи с ценностью продукта.

---

## 5. Публичные правила v1 (для пользователей)

1. Отзыв публикуется с указанием напитка и оценки.
2. Отметка `Подтвержденный визит` появляется при условии: рядом с кофейней (до 150 м) и не менее 7 минут.
3. Подтвержденный визит засчитывается не чаще 1 раза в 4 часа для одной кофейни.
4. Кнопка `Полезно`: нельзя голосовать за свой отзыв; один пользователь - один голос на отзыв.
5. Вес `Полезно` зависит от репутации, но ограничен сверху (не более 1.5x).
6. Репутация растет за полезный и подтвержденный вклад, падает за подтвержденные нарушения.
7. Рейтинг кофейни учитывает надежность и качество сигналов, а не только среднюю оценку.
8. При подозрительной активности часть сигналов может временно иметь пониженный вес.
9. Геоданные используются только для проверки факта визита и не публикуются в профиле/отзыве.
10. Действия модераторов логируются и могут быть перепроверены.

---

## 6. BuildIn-совместимые мини-шаблоны

### 6.1 Шаблон инициативы

```text
Название:
Гипотеза:
Почему сейчас:
Влияние на NSM:
Что делаем:
Что не делаем:
Риски:
Метрики успеха:
Дедлайн:
Ответственный:
```

### 6.2 Шаблон эксперимента

```text
Experiment ID:
Сегмент:
Изменение:
Контроль:
Период:
Primary metric:
Guardrail metrics:
Критерий stop/go:
Результат:
Решение:
```

### 6.3 Шаблон недельного ревью

- Что запустили:
- Что сработало по данным:
- Что не сработало:
- Риски на следующую неделю:
- Решения, которые нужно принять:
